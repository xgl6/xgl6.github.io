{"posts":[{"title":"å®éªŒå®¤ç®¡ç†ç³»ç»Ÿ","content":"1. ğŸ’µ å‰è¨€ åœ¨ä¸ƒæœˆåº•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¼€å§‹äº†é¡¹ç›®é‡æ„ï¼Œåˆ°ä¹æœˆåº•ç¬¬ä¸€ç‰ˆè¦å‡ºï¼Œè¿™ä¹Ÿä¸¤ä¸ªæœˆè¿‡å»äº†ï¼Œæƒ³æŠŠè¿™å…¶ä¸­è‡ªå·±å†™ä»£ç çš„å¿ƒå¾—ï¼Œè¿˜æœ‰ä¸€äº›é‡åˆ°çš„å‘ï¼Œåœ¨è¿™é‡Œéƒ½æ”¾å‡ºæ¥ï¼Œåœ¨ä»¥åé‡åˆ°åŒæ ·é—®é¢˜æ—¶ï¼Œèƒ½æœ‰ä¸ªå¿«é€ŸæŸ¥æ‰¾çš„åœ°æ–¹ã€‚ åœ¨ä¹‹åçš„æ¯ä¸ªé¡¹ç›®ä¸­ï¼Œéƒ½ä¼šé‡‡ç”¨è¿™æ ·çš„å½¢å¼ï¼Œæ‰€ä»¥å°±æŒ‰é¡¹ç›®æ¥åˆ†äº†ã€‚ 2. â˜ï¸ æ¶æ„ æˆ‘ä»¬é‡‡ç”¨äº† SpringBoot + Mybatis + é€šç”¨Mapper + MySQL + Redis å¤§è‡´å¼€å‘æµç¨‹ ç¼–ç  --&gt; æäº¤è‡³Git --&gt; Jenkinsæ„å»º 3.â˜•ï¸ Java 3.1 ğŸˆ å¯¼å…¥/å¯¼å‡º åœ¨ç†éœ€æ±‚æ—¶è€æ¿è¯´è¦å¢åŠ å¯¼å…¥å¯¼å‡ºçš„åŠŸèƒ½ï¼Œäºæ˜¯å°±åœ¨æƒ³è¦æ€ä¹ˆæ¥å®ç°ï¼Œç”±äºæ–‡ä»¶ä¸Šä¼ æ˜¯æ”¾åœ¨æœ¬åœ°æœåŠ¡å™¨çš„ï¼Œæ‰€ä»¥å¤‡ä»½çš„æ—¶å€™ä¹Ÿè¦æŠŠå­˜æ”¾æ–‡ä»¶çš„æ–‡ä»¶å¤¹ä¹Ÿè¦å¤‡ä»½ã€‚ ä¸¤ç§æ–¹æ¡ˆ æŠŠæ•°æ®åº“æ‰€æœ‰çš„æ•°æ®æŸ¥å‡ºæ¥ï¼Œè½¬æˆJsonï¼Œç„¶åæŠŠJsonå†™å…¥æ–‡ä»¶ï¼Œç„¶åæŠŠJsonæ–‡ä»¶å’Œå­˜æ”¾æ–‡ä»¶çš„æ–‡ä»¶å¤¹æ‰“åŒ…æˆzipå‹ç¼©åŒ…è¿”å›ç»™å‰ç«¯ ç›´æ¥å¤‡ä»½SQLæ–‡ä»¶ï¼Œå¹¶æŠŠæ–‡ä»¶å¤¹å’ŒSQLæ‰“åŒ…æˆzipå‹ç¼©åŒ…è¿”å›ç»™å‰ç«¯ æœ€ç»ˆé‡‡ç”¨ç¬¬äºŒç§ï¼Œå…¼å®¹Windowså’ŒLinux import cn.hutool.core.collection.CollUtil; import cn.hutool.core.date.DateUtil; import cn.hutool.core.io.FileTypeUtil; import cn.hutool.core.io.FileUtil; import cn.hutool.core.lang.Assert; import cn.hutool.core.text.StrBuilder; import cn.hutool.core.util.IdUtil; import cn.hutool.core.util.RuntimeUtil; import cn.hutool.core.util.StrUtil; import cn.hutool.core.util.ZipUtil; import cn.hutool.system.OsInfo; import cn.hutool.system.SystemUtil; import cn.hutool.system.UserInfo; import lombok.extern.slf4j.Slf4j; import org.apache.commons.lang3.StringUtils; import org.springframework.scheduling.annotation.Async; import org.springframework.stereotype.Service; import org.springframework.web.multipart.MultipartFile; import java.io.IOException; import java.nio.file.Files; import java.nio.file.Path; import java.nio.file.Paths; import java.util.Arrays; import java.util.Collections; import java.util.List; import java.util.stream.Collectors; import java.util.stream.Stream; /** * @author xgl * @create 2020-07-24 18:32 */ @Service @Slf4j public class BackupServiceImpl implements BackupService { /** * å¯¼å‡ºSQL * * @return è¿”å›è·¯å¾„ */ public String exportSql() { //è·å–ç³»ç»Ÿä¿¡æ¯ OsInfo osInfo = SystemUtil.getOsInfo(); log.info(&quot;ç³»ç»Ÿä¿¡æ¯è¯¦æƒ…:{}&quot;, osInfo); //å®šä¹‰ä¸åŒç³»ç»Ÿçš„æ‰§è¡Œå‘½ä»¤ String sh = &quot;&quot;; String option = &quot;&quot;; StrBuilder strBuilder = StrBuilder.create(); if (osInfo.isWindows()) { sh = &quot;cmd&quot;; option = &quot;/c&quot;; strBuilder.append(&quot;mysqldump -h127.0.0.1 -uroot -proot ym_lims &gt; &quot;); } else if (osInfo.isLinux()) { log.info(&quot;è¿›å…¥äº†Linux&quot;); sh = &quot;/bin/sh&quot;; option = &quot;-c&quot;; //ç”±äºMySQL 5.7 ç‰ˆæœ¬åšäº†é™åˆ¶ éœ€è¦åœ¨my.cnfé…ç½®æ–‡ä»¶é‡Œé…ç½®å¯†ç  strBuilder.append(&quot;/usr/bin/mysqldump -h127.0.0.1 -uroot ym_lims &gt; &quot;); } else { throw new RuntimeException(&quot;æš‚ä¸æ”¯æŒåœ¨å…¶ä»–ç³»ç»Ÿå¯¼å‡º&quot;); } log.info(&quot;å‡†å¤‡ç”Ÿæˆæ–‡ä»¶å&quot;); //ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å //backup-2020-09-14-2090227789.sql //String fileNameFormat = &quot;{}-{}-{}.sql&quot;; //fileNameFormat = StrUtil.format(fileNameFormat, SystemConst.BACKUP_PREFIX, DateUtil.today(), IdUtil.fastSimpleUUID().hashCode()); String fileNameFormat = &quot;backup.sql&quot;; log.info(&quot;DataFileName:{}&quot;, fileNameFormat); //è·å–ç”¨æˆ·ä¸´æ—¶ç›®å½• UserInfo userInfo = SystemUtil.getUserInfo(); String tempDir = userInfo.getTempDir(); //ä¿®æ­£è·¯å¾„ tempDir = FileUtil.normalize(tempDir); String pathFormat = &quot;{}/lims/sql/{}&quot;; pathFormat = StrUtil.format(pathFormat, tempDir, fileNameFormat); //åˆ›å»ºæ–‡ä»¶ FileUtil.touch(pathFormat); strBuilder.append(pathFormat); log.info(&quot;æœ€ç»ˆç”Ÿæˆçš„æ–‡ä»¶{}&quot;, pathFormat); String[] command = {sh, option, strBuilder.toString()}; log.info(&quot;command:{}&quot;, command); Process exec = RuntimeUtil.exec(command); RuntimeUtil.getResultLines(exec); return pathFormat; } /** * æ•°æ®å¤‡ä»½ */ @Async @Override public void exportData(String[] menus) { /** * 1.å¯¼å‡ºsql * 2.å¯¼å‡ºæ–‡ä»¶ * 3.æ”¾å…¥ä¸€ä¸ªå‹ç¼©åŒ…é‡Œ */ String sqlPath = exportSql(); log.info(&quot;sqlPath:{}&quot;, sqlPath); //å¯¼å‡ºæ–‡ä»¶ //è·å–é¡¹ç›®ä¸Šä¸€çº§è·¯å¾„ String parent = ServiceUtils.getProjectPathUpper(); log.info(&quot;parent:{}&quot;, parent); //æ–‡ä»¶å­˜å‚¨çš„è·¯å¾„ String filePath = &quot;{}/public/files&quot;; filePath = StrUtil.format(filePath, parent); //å®šä¹‰è¾“å‡ºç›®å½• String outPath = &quot;{}/public/backup/backup-{}-{}.zip&quot;; outPath = StrUtil.format(outPath, parent, DateUtil.today(), IdUtil.fastSimpleUUID().hashCode()); ZipUtil.zip(FileUtil.file(outPath), true, FileUtil.file(filePath), FileUtil.file(sqlPath)); //æ¸…ç†äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶ String delPath = &quot;{}/lims/sql/backup.sql&quot;; String tempDir = SystemUtil.getUserInfo().getTempDir(); delPath = StrUtil.format(delPath,tempDir); FileUtil.del(delPath); } /** * åˆ—å‡ºæ‰€æœ‰å¯¼å‡ºçš„æ•°æ® * * @return */ @Override public List&lt;BackupDTO&gt; listExportedData() { String path = ServiceUtils.getProjectPathUpper(); Path backupParentPath = Paths.get(path + &quot;/public/backup&quot;); if (Files.notExists(backupParentPath)) { return Collections.emptyList(); } // Build backup dto try (Stream&lt;Path&gt; subPathStream = Files.list(backupParentPath)) { List&lt;BackupDTO&gt; collect = subPathStream .filter(backupPath -&gt; StringUtils.startsWithIgnoreCase(backupPath.getFileName().toString(), SystemConst.BACKUP_PREFIX)) .map(backupPath -&gt; buildBackupDto(&quot;/backup&quot;, backupPath)) //.sorted(Comparator.comparingLong(BackupDTO::getUpdateTime).reversed()) .collect(Collectors.toList()); CollUtil.sort(collect, (o1, o2) -&gt; DateUtil.compare(o2.getUpdateTime(), o1.getUpdateTime())); return collect; } catch (IOException e) { throw new RuntimeException(&quot;Failed to fetch backups&quot;, e); } } /** * æ„å»ºå¤‡ä»½æ–‡ä»¶ * * @param basePath å¤‡ä»½å‰ç¼€ * @param backupPath æ–‡ä»¶å * @return */ private BackupDTO buildBackupDto(String basePath, Path backupPath) { Assert.notNull(basePath, &quot;Base path must not be null&quot;); Assert.notNull(backupPath, &quot;Backup path must not be null&quot;); String backupFileName = backupPath.getFileName().toString(); BackupDTO backup = new BackupDTO(); try { String backupUri = basePath + &quot;/&quot; + backupFileName; backup.setDownloadLink(backupUri); backup.setFilename(backupFileName); backup.setUpdateTime(DateUtil.date(Files.getLastModifiedTime(backupPath).toMillis())); backup.setFileSize(Files.size(backupPath)); } catch (IOException e) { throw new RuntimeException(&quot;Failed to access file &quot; + backupPath, e); } return backup; } /** * å¯¼å…¥æ•°æ® * * @param file */ @Override public void importData(MultipartFile file) throws IOException { /** * 1.å…ˆéªŒè¯æ˜¯å¦æ˜¯zipå‹ç¼©åŒ… * 2.å°†zipæ”¾åˆ°åˆ°ä¸´æ—¶ç›®å½• * 3.è§£å‹åˆ°æ–‡ä»¶åç›¸åŒçš„ç›®å½•ä¸­ * 4.åˆ¤æ–­æ–‡ä»¶çš„å†…å®¹æ˜¯å¦ç¬¦åˆè¦æ±‚ * 5.å¯¼å…¥sql * 6.å¤åˆ¶æ–‡ä»¶ */ //1.éªŒè¯æ˜¯å¦ä¸ºzipå‹ç¼©åŒ… String type = FileTypeUtil.getType(file.getInputStream()); if (!StrUtil.equals(type, FileConst.ZIP)) { throw new RuntimeException(&quot;åªå…è®¸ä¼ zipå‹ç¼©åŒ…&quot;); } //2.å°†zipæ”¾åˆ°åˆ°ä¸´æ—¶ç›®å½• //2.1 ç”Ÿæˆä¸´æ—¶ç›®å½• // ä¸´æ—¶æ–‡ä»¶æ ·ä¾‹ /tmp/lims/upload/2020-09-22/UUID/backup.zip String tempPath = &quot;{}/lims/upload/{}/{}/backup.zip&quot;; UserInfo userInfo = SystemUtil.getUserInfo(); String tempDir = userInfo.getTempDir(); int code = IdUtil.fastSimpleUUID().hashCode(); tempPath = StrUtil.format(tempPath, tempDir, DateUtil.today(), code); FileUtil.writeFromStream(file.getInputStream(), tempPath); //3.è§£å‹åˆ°æ–‡ä»¶åç›¸åŒçš„ç›®å½•ä¸­,ä¹Ÿå°±æ˜¯ /tmp/lims/upload/2020-09-22/UUID/backup/** ZipUtil.unzip(tempPath); //3.1 å¯¹tempPathè¿›è¡Œå¤„ç†,å»æ‰æ–‡ä»¶ååç¼€ String subBefore = StrUtil.subBefore(tempPath, &quot;.zip&quot;, true); //3.2 ä¿®æ­£è·¯å¾„ subBefore = FileUtil.normalize(subBefore); //4.åˆ¤æ–­æ–‡ä»¶çš„å†…å®¹æ˜¯å¦ç¬¦åˆè¦æ±‚,ä¹Ÿå°±æ˜¯ä¸€ä¸ªsqlæ–‡ä»¶,ä¸€ä¸ªfilesæ–‡ä»¶å¤¹ boolean sqlExist = FileUtil.exist(subBefore + &quot;/backup.sql&quot;); if (!sqlExist) { FileUtil.del(tempDir + &quot;/lims/upload/&quot;); throw new RuntimeException(&quot;ä¸Šä¼ çš„zipå‹ç¼©åŒ…é‡Œæ²¡æœ‰sqlæ–‡ä»¶&quot;); } boolean filesExist = FileUtil.exist(subBefore + &quot;/files&quot;); if (!filesExist) { FileUtil.del(tempDir + &quot;/lims/upload/&quot;); throw new RuntimeException(&quot;ä¸Šä¼ çš„zipå‹ç¼©åŒ…é‡Œæ²¡æœ‰filesæ–‡ä»¶å¤¹&quot;); } //5.å¼€å§‹å¯¼å…¥SQL String sh = &quot;&quot;; String option = &quot;&quot;; StrBuilder strBuilder = StrBuilder.create(); OsInfo osInfo = SystemUtil.getOsInfo(); if (osInfo.isWindows()) { //5.1 Windowsç¯å¢ƒä¸‹çš„å¯¼å…¥ sh = &quot;cmd&quot;; option = &quot;/c&quot;; strBuilder.append(&quot;mysql -h127.0.0.1 -uroot -proot ym_lims &lt; &quot;); } else if (osInfo.isLinux()) { //5.2 Linuxç¯å¢ƒä¸‹çš„å¯¼å…¥ sh = &quot;/bin/sh&quot;; option = &quot;-c&quot;; //ç”±äºMySQL 5.7 ç‰ˆæœ¬åšäº†é™åˆ¶ éœ€è¦åœ¨my.cnfé…ç½®æ–‡ä»¶é‡Œé…ç½®å¯†ç  strBuilder.append(&quot;/usr/bin/mysql -h127.0.0.1 -uroot ym_lims &lt; &quot;); } else { throw new RuntimeException(&quot;ä¸æ”¯æŒçš„ç³»ç»Ÿç±»å‹,å¯¼å…¥ç»ˆæ­¢&quot;); } strBuilder.append(subBefore); strBuilder.append(&quot;/backup.sql&quot;); String[] command = {sh, option, strBuilder.toString()}; log.info(&quot;command:{}&quot;, Arrays.toString(command)); Process exec = RuntimeUtil.exec(command); List&lt;String&gt; resultLines = RuntimeUtil.getResultLines(exec); for (String resultLine : resultLines) { log.info(&quot;resultLine:{}&quot;,resultLine); } //6.ç§»åŠ¨æ–‡ä»¶ String filesPath = subBefore + &quot;/files&quot;; String projectPath = ServiceUtils.getProjectPathUpper(); projectPath = projectPath + &quot;/public/&quot;; FileUtil.move(FileUtil.file(filesPath),FileUtil.file(projectPath),true); //7.åˆ é™¤äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶ String delPath = &quot;{}/lims/upload/{}/{}/&quot;; delPath = StrUtil.format(delPath,tempDir,DateUtil.today(),code); FileUtil.del(delPath); } /** * åˆ é™¤æ–‡ä»¶ * @param filename */ @Override public void deleteExportedData(String filename) { String projectPath = ServiceUtils.getProjectPathUpper(); projectPath = projectPath + &quot;/public/backup/&quot; + filename; FileUtil.del(projectPath); } } ","link":"https://xgl6.github.io/post/Lab/"},{"title":"Hello Gridea","content":"ğŸ‘ æ¬¢è¿ä½¿ç”¨ Gridea ï¼ âœï¸ Gridea ä¸€ä¸ªé™ æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ... Github Gridea ä¸»é¡µ ç¤ºä¾‹ç½‘ç«™ ç‰¹æ€§ğŸ‘‡ ğŸ“ ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ Markdown è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ ğŸŒ‰ ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡ ğŸ·ï¸ ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„ ğŸ“‹ ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå• ğŸ’» ä½ å¯ä»¥åœ¨ Windowsï¼ŒMacOS æˆ– Linux è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯ ğŸŒ ä½ å¯ä»¥ä½¿ç”¨ ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ æˆ– Coding Pages å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å° ğŸ’¬ ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ Gitalk æˆ– DisqusJS è¯„è®ºç³»ç»Ÿ ğŸ‡¬ğŸ‡§ ä½ å¯ä»¥ä½¿ç”¨ä¸­æ–‡ç®€ä½“æˆ–è‹±è¯­ ğŸŒ ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ› ğŸ–¥ ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥ ğŸŒ± å½“ç„¶ Gridea è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ ğŸƒ æœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´ å°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼ å•¦å•¦å•¦ ğŸ˜˜ Enjoy~ ","link":"https://xgl6.github.io/post/hello-gridea/"}]}